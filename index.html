function triggerDownload(content, name) {
  const BOM = "\uFEFF";
  const finalContent = BOM + content;

  const newWindow = window.open("", "_blank");

  if (!newWindow) {
    alert("Popup blocked! Please allow popups in app settings.");
    return;
  }

  newWindow.document.write(`
    <html>
    <head>
      <title>${name}</title>
      <meta charset="UTF-8"/>
      <style>
        body { font-family: Arial; padding: 20px; }
        textarea { width: 100%; height: 70vh; font-size: 13px; }
        button {
          padding: 12px 20px;
          background: #16a34a;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          margin-bottom: 15px;
        }
      </style>
    </head>
    <body>
      <h2>CSV Ready: ${name}</h2>
      <p>Click download button below.</p>
      <button onclick="downloadFile()">â¬‡ Download CSV</button>
      <textarea id="csvBox"></textarea>

      <script>
        const csvData = \`${finalContent.replace(/`/g, "\\`")}\`;

        document.getElementById("csvBox").value = csvData;

        function downloadFile() {
          const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "${name}";
          a.click();

          URL.revokeObjectURL(url);
        }
      </script>
    </body>
    </html>
  `);

  newWindow.document.close();
}
