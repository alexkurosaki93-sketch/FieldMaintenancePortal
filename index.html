<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Field Maintenance Portal</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f4f6f9; color:#222;}

    header {
      text-align:center;
      padding:15px;
      background:#1e293b;
      color:white;
    }

    header h2 {margin:5px; font-size:22px;}
    header p {margin:0; font-size:14px; opacity:0.9;}

    .container {padding:15px;}

    .tabs {display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;}
    .tab-btn {
      flex:1;
      padding:12px;
      border:none;
      background:#e2e8f0;
      color:#111;
      font-size:15px;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
      min-width:120px;
    }
    .tab-btn.active {background:#2563eb; color:white;}

    .tab-content {display:none;}
    .tab-content.active {display:block;}

    .refresh-btn {
      width:100%;
      padding:12px;
      border:none;
      background:#2563eb;
      color:white;
      font-size:15px;
      border-radius:10px;
      cursor:pointer;
      margin-bottom:15px;
    }
    .refresh-btn:hover {background:#1d4ed8;}

    .logout-btn {
      width:100%;
      padding:12px;
      border:none;
      background:#ef4444;
      color:white;
      font-size:15px;
      border-radius:10px;
      cursor:pointer;
      margin-bottom:15px;
      font-weight:bold;
    }
    .logout-btn:hover {background:#dc2626;}

    .status {text-align:center; font-size:13px; margin-bottom:10px; font-weight:bold;}

    .kpi-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:12px;
      margin-bottom:15px;
    }

    .kpi-card {
      background:white;
      padding:15px;
      border-radius:12px;
      text-align:center;
      box-shadow:0px 2px 8px rgba(0,0,0,0.1);
    }

    .kpi-card h3 {font-size:14px; margin:0; color:#555;}
    .kpi-card p {font-size:22px; margin:8px 0 0; font-weight:bold; color:#2563eb;}

    .chart-area {display:grid; grid-template-columns:1fr; gap:15px;}

    .chart-box {
      background:white;
      padding:15px;
      border-radius:12px;
      box-shadow:0px 2px 8px rgba(0,0,0,0.1);
      height:360px;
    }

    .chart-box canvas {
      max-height:280px !important;
    }

    .table-area {
      margin-top:20px;
      background:white;
      padding:15px;
      border-radius:12px;
      overflow-x:auto;
      box-shadow:0px 2px 8px rgba(0,0,0,0.1);
    }

    table {width:100%; border-collapse:collapse; font-size:13px;}
    thead {background:#2563eb; color:white;}
    th, td {padding:10px; border:1px solid #ddd; text-align:center;}

    footer {
      text-align:center;
      padding:12px;
      background:#0f172a;
      color:white;
      margin-top:20px;
    }

    .smalltext {font-size:12px; opacity:0.8;}

    .filter-box {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:15px;
    }

    select, input {
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
      flex:1;
      min-width:180px;
    }

    .export-btn {
      padding:10px;
      border:none;
      background:#16a34a;
      color:white;
      font-weight:bold;
      border-radius:8px;
      cursor:pointer;
      flex:1;
      min-width:180px;
    }

    .export-btn:hover {background:#15803d;}

    .download-btn {
      padding:6px 10px;
      background:#16a34a;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }

    .download-btn:hover {background:#15803d;}

    iframe {
      width:100%;
      height:900px;
      border:none;
      border-radius:12px;
      background:white;
      box-shadow:0px 2px 8px rgba(0,0,0,0.1);
    }

    /* LOGIN PAGE */
    .login-box {
      max-width:420px;
      margin:40px auto;
      background:white;
      padding:25px;
      border-radius:15px;
      box-shadow:0px 2px 10px rgba(0,0,0,0.15);
      text-align:center;
    }

    .login-box h2 {margin:0; color:#1e293b;}
    .login-box p {font-size:13px; color:#555;}

    .login-box input {
      width:100%;
      margin-top:12px;
      padding:12px;
      font-size:15px;
      border-radius:10px;
      border:1px solid #ccc;
    }

    .login-btn {
      width:100%;
      margin-top:15px;
      padding:12px;
      border:none;
      background:#2563eb;
      color:white;
      font-size:15px;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
    }

    .login-btn:hover {background:#1d4ed8;}

    .error-text {
      color:red;
      font-size:13px;
      margin-top:10px;
      font-weight:bold;
    }

    .success-text {
      color:green;
      font-size:13px;
      margin-top:10px;
      font-weight:bold;
    }
  </style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-box">
  <h2>üîê Field Maintenance Portal</h2>
  <p>Please login to continue</p>

  <input type="text" id="loginUsername" placeholder="Enter Username"/>
  <input type="password" id="loginPassword" placeholder="Enter Password"/>

  <button class="login-btn" onclick="login()">Login</button>

  <div id="loginMsg" class="error-text"></div>
</div>

<!-- MAIN APP -->
<div id="appScreen" style="display:none;">

  <header>
    <h2>üìä Field Maintenance Portal</h2>
    <p id="welcomeText">Welcome</p>
  </header>

  <div class="container">

    <button class="logout-btn" onclick="logout()">üö™ Logout</button>

    <!-- TAB BUTTONS -->
    <div class="tabs" id="tabButtons"></div>

    <!-- DASHBOARD TAB -->
    <div id="dashboardTab" class="tab-content">

      <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
      <div class="status" id="statusText">Loading data...</div>

      <div class="kpi-grid">
        <div class="kpi-card"><h3>Total MI</h3><p id="kpi_total">0</p></div>
        <div class="kpi-card"><h3>Comm</h3><p id="kpi_comm">0</p></div>
        <div class="kpi-card"><h3>Non Comm</h3><p id="kpi_noncomm">0</p></div>
        <div class="kpi-card"><h3>Never Comm</h3><p id="kpi_nevercomm">0</p></div>
        <div class="kpi-card"><h3>Pending %</h3><p id="kpi_pending_pct">0%</p></div>
        <div class="kpi-card"><h3>Comm %</h3><p id="kpi_comm_pct">0%</p></div>
      </div>

      <div class="chart-area">
        <div class="chart-box">
          <h3>Communication Status Breakdown</h3>
          <canvas id="statusChart"></canvas>
        </div>

        <div class="chart-box">
          <h3>Top 15 Sub Division Wise Pending</h3>
          <p class="smalltext">Pending = Non Comm + Never Comm</p>
          <canvas id="subdivisionChart"></canvas>
        </div>
      </div>

      <div class="table-area">
        <h3>üìã Executive + Sub Division Pending Summary</h3>
        <p class="smalltext">Pending = Non Comm + Never Comm</p>

        <table id="summaryTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <!-- MASTER SHEET TAB -->
    <div id="sheetTab" class="tab-content">

      <h3>üìë Master Sheet View</h3>
      <p class="smalltext">Filter by Sub Division + Export filtered data</p>

      <div class="filter-box">
        <select id="subdivisionFilter" onchange="renderFullTable()">
          <option value="">All Sub Divisions</option>
        </select>

        <input type="text" id="searchBox" placeholder="Search anything..." onkeyup="renderFullTable()"/>

        <button class="export-btn" onclick="exportFilteredCSV()">‚¨á Export Filtered Excel</button>
      </div>

      <div class="table-area">
        <table id="fullDataTable">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p class="smalltext">Showing max 200 rows for performance.</p>
      </div>

    </div>

    <!-- FORM TAB -->
    <div id="formTab" class="tab-content">
      <h3>üìù Submit Field Report</h3>
      <p class="smalltext">Fill the form below to submit your work update.</p>

      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdrEm24HgilvW_FcRx_hMwIFS-1htDyqj_R30ov9T8ObCENSQ/viewform?embedded=true"></iframe>
    </div>

    <!-- ACCESS MANAGEMENT TAB (ADMIN ONLY) -->
    <div id="accessTab" class="tab-content">
      <h3>üîê Access Management</h3>
      <p class="smalltext">Admin can add or remove users here.</p>

      <div class="table-area">
        <h3>Add New User</h3>

        <input type="text" id="newUsername" placeholder="Enter Username"/>
        <input type="password" id="newPassword" placeholder="Enter Password"/>

        <select id="newRole">
          <option value="EXECUTIVE">EXECUTIVE</option>
          <option value="TECHNICIAN">TECHNICIAN</option>
          <option value="ADMIN">ADMIN</option>
        </select>

        <button class="export-btn" onclick="addUser()">‚ûï Add User</button>

        <div id="accessMsg" class="success-text"></div>
      </div>

      <div class="table-area">
        <h3>Existing Users</h3>

        <table id="usersTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <footer>
    <p>Developed by Porag Kumar Das ‚ù§Ô∏è</p>
  </footer>

</div>

<script>
const ADMIN_USERNAME = "porag.das";
const ADMIN_PASSWORD = "gknayakg07";

// üîê Hardcoded Users (Edit Here Anytime)
const USERS = [
  {
    username: "Rhittik.bt@maintenance.in",
    password: "Rhittik@123",
    role: "EXECUTIVE"
  },
  {
    username: "test.tech@maintenance.in",
    password: "Tech@123",
    role: "TECHNICIAN"
  }
];

let currentUser = null;
let currentRole = null;

let statusChart, subdivisionChart;
let masterData = [];
let rawHeaders = [];

const DATA_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNuAp9IwF1UnVU4INnUt0IaHcBVA5c7EFYKMBTVXjC0fC4Wbv2_20cJUSUQk3iQ7RQt_e8BwLjrp0Y/pub?gid=405039605&single=true&output=csv";

function login() {
  let username = document.getElementById("loginUsername").value.trim();
  let password = document.getElementById("loginPassword").value.trim();
  let msgBox = document.getElementById("loginMsg");

  msgBox.innerText = "";

  if (!username || !password) {
    msgBox.innerText = "‚ùå Enter Username and Password";
    return;
  }

  // Admin login
  if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
    currentUser = username;
    currentRole = "ADMIN";
    showApp();
    return;
  }

  // Hardcoded user check
  let found = USERS.find(u =>
    u.username === username && u.password === password
  );

  if (!found) {
    msgBox.innerText = "‚ùå Invalid Username or Password";
    return;
  }

  currentUser = found.username;
  currentRole = found.role;

  showApp();
}

function logout() {
  document.getElementById("appScreen").style.display = "none";
  document.getElementById("loginScreen").style.display = "block";

  document.getElementById("loginUsername").value = "";
  document.getElementById("loginPassword").value = "";
  document.getElementById("loginMsg").innerText = "";
}

function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("appScreen").style.display = "block";

  document.getElementById("welcomeText").innerText =
    "Welcome " + currentUser + " (" + currentRole + ")";

  buildTabsByRole();
  openTab("dashboardTab");
  loadData();
}

function buildTabsByRole() {
  let tabButtons = document.getElementById("tabButtons");
  tabButtons.innerHTML = "";

  let tabs = [
    { id: "dashboardTab", name: "üìä Dashboard" },
    { id: "sheetTab", name: "üìë Master Sheet" },
    { id: "formTab", name: "üìù Submit Form" }
  ];

  if (currentRole === "ADMIN") {
    tabs.push({ id: "accessTab", name: "üîê Access" });
  }

  tabs.forEach(tab => {
    let btn = document.createElement("button");
    btn.className = "tab-btn";
    btn.innerText = tab.name;
    btn.onclick = () => openTab(tab.id);
    tabButtons.appendChild(btn);
  });
}

function openTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));

  document.getElementById(tabId).classList.add("active");

  let buttons = document.querySelectorAll(".tab-btn");
  buttons.forEach(btn => {
    if (btn.onclick.toString().includes(tabId)) {
      btn.classList.add("active");
    }
  });
}

/* ---- DO NOT TOUCH BELOW (YOUR ORIGINAL DATA LOGIC) ---- */

function cleanText(value) {
  if (value === null || value === undefined) return "";
  return String(value).trim();
}

function normalizeStatus(status) {
  status = cleanText(status).toLowerCase();
  if (status.includes("never")) return "Never Comm";
  if (status.includes("non")) return "Non Comm";
  if (status.includes("comm")) return "Comm";
  return "Unknown";
}

function parseCSVLine(line) {
  let result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    let char = line[i];

    if (char === '"' && line[i + 1] === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }

  result.push(current);
  return result;
}

async function fetchCSVWithRetry(url, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      let finalURL = url + "&nocache=" + new Date().getTime();
      let response = await fetch(finalURL);

      if (!response.ok) throw new Error("HTTP Error");

      let text = await response.text();
      if (text.length < 5000) throw new Error("Incomplete Data");

      return text;
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
}

async function loadData() {
  document.getElementById("statusText").innerText = "Loading data...";

  try {
    let csvText = await fetchCSVWithRetry(DATA_URL, 3);
    let lines = csvText.split("\n").filter(line => line.trim() !== "");

    rawHeaders = parseCSVLine(lines[0]);
    masterData = [];

    for (let i = 1; i < lines.length; i++) {
      let cols = parseCSVLine(lines[i]);
      masterData.push(cols);
    }

    document.getElementById("statusText").innerText =
      "‚úÖ Data Loaded Successfully (" + masterData.length + " Records)";

  } catch (err) {
    document.getElementById("statusText").innerText = "‚ùå Data Load Failed.";
  }
}
</script>

</body>
</html>
