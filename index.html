<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DT Maintenance App</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #ffffff;
    overflow: hidden;
  }

  header {
    background: #0d47a1;
    color: white;
    padding: 12px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 999;
  }

  .container {
    padding-top: 55px;
    padding-bottom: 65px;
    height: 100vh;
    box-sizing: border-box;
  }

  /* Login box */
  .login-box {
    max-width: 420px;
    margin: auto;
    padding: 20px;
  }

  .login-box h2 {
    text-align: center;
    color: #0d47a1;
  }

  input {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 15px;
    box-sizing: border-box;
  }

  /* Password wrapper with eye */
  .password-wrapper {
    position: relative;
    width: 100%;
  }

  .password-wrapper input {
    padding-right: 45px; /* space for eye icon */
  }

  .eye-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 18px;
    color: #0d47a1;
    user-select: none;
  }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    background: #0d47a1;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
  }

  button:hover {
    background: #08367d;
  }

  .error {
    color: crimson;
    font-weight: bold;
    text-align: center;
    margin-top: 12px;
  }

  /* Tabs */
  .tab {
    width: 100%;
    height: 100%;
    display: none;
  }

  .tab.active {
    display: block;
  }

  /* Crop box for Google Sheets */
  .sheet-crop-box {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
    background: white;
  }

  .sheet-crop-box iframe {
    width: 1400px;
    height: 1000px;
    border: none;
    transform: scale(0.85);
    transform-origin: top left;
    position: absolute;
    top: -95px;
    left: -70px;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .sheet-crop-box iframe {
      width: 1200px;
      height: 1000px;
      transform: scale(0.70);
      top: -110px;
      left: -90px;
    }
  }

  @media (max-width: 480px) {
    .sheet-crop-box iframe {
      width: 1200px;
      height: 1000px;
      transform: scale(0.63);
      top: -115px;
      left: -110px;
    }
  }

  /* Form iframe */
  .form-box {
    width: 100%;
    height: 100%;
  }

  .form-box iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Admin Panel */
  .admin-panel {
    padding: 15px;
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
    background: #f4f6fb;
  }

  .admin-card {
    background: white;
    padding: 15px;
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    margin-bottom: 15px;
  }

  .admin-card h3 {
    margin: 0;
    color: #0d47a1;
  }

  .admin-card p {
    color: #444;
    font-size: 13px;
  }

  .save-btn {
    background: green;
  }

  .save-btn:hover {
    background: darkgreen;
  }

  /* Bottom nav */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ddd;
    padding: 10px 0;
    z-index: 999;
  }

  .bottom-nav button {
    background: none;
    border: none;
    font-size: 13px;
    font-weight: bold;
    color: #0d47a1;
    padding: 6px 10px;
    border-radius: 10px;
    cursor: pointer;
    width: auto;
    margin: 0;
  }

  .bottom-nav button.active {
    background: #0d47a1;
    color: white;
  }

  .hidden {
    display: none;
  }

  .logout-btn {
    background: crimson !important;
    color: white !important;
  }
</style>
</head>

<body>

<header id="headerTitle">DT Maintenance App</header>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="container">
  <div class="login-box">
    <h2>üîê Login</h2>
    <p style="text-align:center;color:#444;">Enter your username & password</p>

    <input type="text" id="username" placeholder="Username">

    <!-- PASSWORD WITH EYE ICON -->
    <div class="password-wrapper">
      <input type="password" id="password" placeholder="Password">
      <span class="eye-btn" onclick="togglePassword()">üëÅ</span>
    </div>

    <button onclick="login()">Login</button>

    <p id="err" class="error"></p>

    <p style="text-align:center;color:#777;margin-top:20px;font-size:13px;">
      App developed by porag kumar das‚ù§Ô∏è
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="container hidden">

  <!-- DASHBOARD TAB -->
  <div id="tabDashboard" class="tab active">
    <div class="sheet-crop-box">
      <iframe id="dashboardFrame"></iframe>
    </div>
  </div>

  <!-- DOWNLOADS TAB -->
  <div id="tabDownloads" class="tab">
    <div class="sheet-crop-box">
      <iframe id="downloadsFrame"></iframe>
    </div>
  </div>

  <!-- FORM TAB -->
  <div id="tabForm" class="tab">
    <div class="form-box">
      <iframe id="formFrame"></iframe>
    </div>
  </div>

  <!-- ADMIN TAB -->
  <div id="tabAdmin" class="tab">
    <div class="admin-panel">

      <div class="admin-card">
        <h3>Admin Settings</h3>
        <p>Update links here. Saved in browser.</p>

        <label><b>Dashboard Sheet Link</b></label>
        <input type="text" id="dashLinkInput" placeholder="Paste dashboard published link">

        <label><b>Downloads Sheet Link</b></label>
        <input type="text" id="downloadLinkInput" placeholder="Paste downloads published link">

        <label><b>Google Form Embed Link</b></label>
        <input type="text" id="formLinkInput" placeholder="Paste google form embed link">

        <button class="save-btn" onclick="saveAdminLinks()">Save Links</button>
      </div>

      <div class="admin-card">
        <h3>Note</h3>
        <p>
          Admin changes apply only on this device unless you host backend.
          For global config, we can store links in Google Sheet also.
        </p>
      </div>

    </div>
  </div>

</div>

<!-- BOTTOM NAV -->
<div id="bottomNav" class="bottom-nav hidden">
  <button id="btnDashboard" class="active" onclick="showTab('dashboard')">Dashboard</button>
  <button id="btnDownloads" onclick="showTab('downloads')">Downloads</button>
  <button id="btnForm" onclick="showTab('form')">Form</button>
  <button id="btnAdmin" class="hidden" onclick="showTab('admin')">Admin</button>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script>
  // ==============================
  // PASSWORD EYE TOGGLE
  // ==============================
  function togglePassword() {
    let passField = document.getElementById("password");

    if (passField.type === "password") {
      passField.type = "text";
    } else {
      passField.type = "password";
    }
  }

  // ==============================
  // FIXED ADMIN LOGIN
  // ==============================
  const ADMIN_USERNAME = "porag.das";
  const ADMIN_PASSWORD = "gknayakg07";

  // ==============================
  // USERS SHEET CSV (Executive/Technician)
  // ==============================
  const USERS_SHEET_CSV =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQEYtdLJy6g0hojsLh-dPPMc8UFOFFw7aOSM7YUcoO7i6eq_ZCbXSuCGD4A8D_hzh2jb4OuxAGdzaQ/pub?output=csv&gid=0";

  // ==============================
  // DEFAULT LINKS
  // ==============================
  const DEFAULT_DASHBOARD_LINK =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNuAp9IwF1UnVU4INnUt0IaHcBVA5c7EFYKMBTVXjC0fC4Wbv2_20cJUSUQk3iQ7RQt_e8BwLjrp0Y/pubhtml?gid=0&single=true";

  const DEFAULT_DOWNLOADS_LINK =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNuAp9IwF1UnVU4INnUt0IaHcBVA5c7EFYKMBTVXjC0fC4Wbv2_20cJUSUQk3iQ7RQt_e8BwLjrp0Y/pubhtml?gid=405039605&single=true";

  const DEFAULT_FORM_LINK =
    "https://docs.google.com/forms/d/e/FORM_ID/viewform?embedded=true";

  let usersData = [];

  // Load saved links
  let dashboardLink = localStorage.getItem("dashboardLink") || DEFAULT_DASHBOARD_LINK;
  let downloadsLink = localStorage.getItem("downloadsLink") || DEFAULT_DOWNLOADS_LINK;
  let formLink = localStorage.getItem("formLink") || DEFAULT_FORM_LINK;

  // Fetch users list
  fetch(USERS_SHEET_CSV)
    .then(res => res.text())
    .then(text => {
      usersData = parseCSV(text);
    })
    .catch(err => {
      console.error("Could not load users sheet:", err);
    });

  // ==============================
  // LOGIN FUNCTION
  // ==============================
  function login() {
    let user = document.getElementById("username").value.trim();
    let pass = document.getElementById("password").value.trim();
    let err = document.getElementById("err");

    err.innerText = "";

    if (!user || !pass) {
      err.innerText = "Enter username and password";
      return;
    }

    // ADMIN FIXED LOGIN
    if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
      localStorage.setItem("loggedInUser", user);
      localStorage.setItem("loggedInRole", "admin");
      startApp();
      return;
    }

    // Executive / Technician from Google Sheet
    if (!usersData || usersData.length === 0) {
      err.innerText = "User list not loaded yet. Try again in 2 seconds.";
      return;
    }

    let foundRole = null;

    for (let i = 1; i < usersData.length; i++) {
      let row = usersData[i];

      let sheetUser = (row[0] || "").trim();
      let sheetPass = (row[1] || "").trim();
      let sheetRole = (row[2] || "").trim().toLowerCase();

      if (sheetUser === user && sheetPass === pass) {
        foundRole = sheetRole;
        break;
      }
    }

    if (!foundRole) {
      err.innerText = "‚ùå Access Denied (Invalid Username or Password)";
      return;
    }

    if (foundRole !== "executive" && foundRole !== "technician") {
      err.innerText = "‚ùå Access Denied (Role not allowed)";
      return;
    }

    localStorage.setItem("loggedInUser", user);
    localStorage.setItem("loggedInRole", foundRole);

    startApp();
  }

  // ==============================
  // START APP AFTER LOGIN
  // ==============================
  function startApp() {
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainApp").classList.remove("hidden");
    document.getElementById("bottomNav").classList.remove("hidden");

    let role = localStorage.getItem("loggedInRole");

    document.getElementById("headerTitle").innerText =
      "DT Maintenance App (" + role.toUpperCase() + ")";

    // Set iframe links
    document.getElementById("dashboardFrame").src = dashboardLink;
    document.getElementById("downloadsFrame").src = downloadsLink;
    document.getElementById("formFrame").src = formLink;

    // Admin tab visible only for admin
    if (role === "admin") {
      document.getElementById("btnAdmin").classList.remove("hidden");
      loadAdminInputs();
    } else {
      document.getElementById("btnAdmin").classList.add("hidden");
    }
  }

  // ==============================
  // SAVE ADMIN LINKS
  // ==============================
  function saveAdminLinks() {
    dashboardLink = document.getElementById("dashLinkInput").value.trim();
    downloadsLink = document.getElementById("downloadLinkInput").value.trim();
    formLink = document.getElementById("formLinkInput").value.trim();

    if (!dashboardLink || !downloadsLink || !formLink) {
      alert("Please fill all links!");
      return;
    }

    localStorage.setItem("dashboardLink", dashboardLink);
    localStorage.setItem("downloadsLink", downloadsLink);
    localStorage.setItem("formLink", formLink);

    // Reload iframes
    document.getElementById("dashboardFrame").src = dashboardLink;
    document.getElementById("downloadsFrame").src = downloadsLink;
    document.getElementById("formFrame").src = formLink;

    alert("Links Updated Successfully!");
  }

  function loadAdminInputs() {
    document.getElementById("dashLinkInput").value = dashboardLink;
    document.getElementById("downloadLinkInput").value = downloadsLink;
    document.getElementById("formLinkInput").value = formLink;
  }

  // ==============================
  // LOGOUT
  // ==============================
  function logout() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInRole");
    location.reload();
  }

  // ==============================
  // TAB SWITCHING
  // ==============================
  function showTab(tab) {
    document.getElementById("tabDashboard").classList.remove("active");
    document.getElementById("tabDownloads").classList.remove("active");
    document.getElementById("tabForm").classList.remove("active");
    document.getElementById("tabAdmin").classList.remove("active");

    document.getElementById("btnDashboard").classList.remove("active");
    document.getElementById("btnDownloads").classList.remove("active");
    document.getElementById("btnForm").classList.remove("active");
    document.getElementById("btnAdmin").classList.remove("active");

    if (tab === "dashboard") {
      document.getElementById("tabDashboard").classList.add("active");
      document.getElementById("btnDashboard").classList.add("active");
    }

    if (tab === "downloads") {
      document.getElementById("tabDownloads").classList.add("active");
      document.getElementById("btnDownloads").classList.add("active");
    }

    if (tab === "form") {
      document.getElementById("tabForm").classList.add("active");
      document.getElementById("btnForm").classList.add("active");
    }

    if (tab === "admin") {
      document.getElementById("tabAdmin").classList.add("active");
      document.getElementById("btnAdmin").classList.add("active");
    }
  }

  // ==============================
  // AUTO LOGIN IF SESSION EXISTS
  // ==============================
  if (localStorage.getItem("loggedInUser")) {
    startApp();
  }

  // ==============================
  // SIMPLE CSV PARSER
  // ==============================
  function parseCSV(text) {
    let rows = text.trim().split("\n");
    return rows.map(row => row.split(","));
  }
</script>

</body>
</html>
