<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Field Maintenance Portal</title>

<style>
body { font-family: Arial; background:#f4f6f9; margin:0; }

.login-box {
  max-width:400px;
  margin:60px auto;
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
  text-align:center;
}

input, select {
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

button {
  width:100%;
  padding:12px;
  margin-top:15px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

button:hover { background:#1d4ed8; }

.tabs {
  display:flex;
  gap:10px;
  padding:10px;
  background:#111827;
}

.tab-btn {
  flex:1;
  padding:10px;
  border:none;
  background:#374151;
  color:white;
  border-radius:8px;
  cursor:pointer;
}

.tab-btn.active { background:#2563eb; }

.tab-content { display:none; padding:15px; }
.tab-content.active { display:block; }

iframe {
  width:100%;
  height:800px;
  border:none;
  border-radius:10px;
}

.table-box {
  background:white;
  padding:15px;
  border-radius:10px;
  margin-top:20px;
}

</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-box">
  <h2>üîê Field Maintenance Portal</h2>

  <input type="text" id="loginUsername" placeholder="Username">

  <div style="position:relative;">
    <input type="password" id="loginPassword" placeholder="Password" style="padding-right:40px;">
    <span onclick="togglePassword()" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer;">üëÅÔ∏è</span>
  </div>

  <button onclick="login()">Login</button>
  <div id="loginMsg" style="color:red; margin-top:10px;"></div>
</div>

<!-- MAIN APP -->
<div id="appScreen" style="display:none;">

<div class="tabs" id="tabButtons"></div>

<div id="dashboardTab" class="tab-content">
  <h3>üìä Dashboard</h3>
  <p>Dashboard Content Here</p>
</div>

<div id="sheetTab" class="tab-content">
  <h3>üìë Master Sheet</h3>
  <p>Master Sheet Content Here</p>
</div>

<div id="formTab" class="tab-content">
  <h3>üìù Submit Form</h3>
  <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdrEm24HgilvW_FcRx_hMwIFS-1htDyqj_R30ov9T8ObCENSQ/viewform?embedded=true"></iframe>
</div>

<div id="accessTab" class="tab-content">
  <h3>üîê Access Management</h3>

  <div class="table-box">
    <h4>Add New User</h4>
    <input type="text" id="newUsername" placeholder="Username">
    <input type="password" id="newPassword" placeholder="Password">
    <select id="newRole">
      <option value="EXECUTIVE">EXECUTIVE</option>
      <option value="TECHNICIAN">TECHNICIAN</option>
      <option value="ADMIN">ADMIN</option>
    </select>
    <button onclick="addUser()">‚ûï Add User</button>
  </div>

</div>

</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>

const ADMIN_USERNAME = "porag.das";
const ADMIN_PASSWORD = "gknayakg07";

const ACCESS_SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSQEYtdLJy6g0hojsLh-dPPMc8UFOFFw7aOSM7YUcoO7i6eq_ZCbXSuCGD4A8D_hzh2jb4OuxAGdzaQ/pub?gid=0&single=true&output=csv";

const ADD_USER_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzko5XYC3R4qkNVxRRGYZ0MrOHasS2nI5T5qpSMQhh6BtL9srGzYa9nIAfbK7o--0SD/exec";

let currentUser = null;
let currentRole = null;

function togglePassword() {
  let p = document.getElementById("loginPassword");
  p.type = p.type === "password" ? "text" : "password";
}

async function login() {

  let username = document.getElementById("loginUsername").value.trim();
  let password = document.getElementById("loginPassword").value.trim();
  let msg = document.getElementById("loginMsg");

  msg.innerText = "";

  if (!username || !password) {
    msg.innerText = "Enter Username and Password";
    return;
  }

  if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
    currentUser = username;
    currentRole = "ADMIN";
    showApp();
    return;
  }

  try {
    let res = await fetch(ACCESS_SHEET_URL + "&nocache=" + new Date().getTime());
    let text = await res.text();
    let lines = text.split("\n").filter(x => x.trim() !== "");

    let found = false;

    for (let i = 1; i < lines.length; i++) {
      let cols = lines[i].split(",");
      if (cols[0]?.trim() === username && cols[1]?.trim() === password) {
        currentUser = username;
        currentRole = cols[2]?.trim().toUpperCase();
        found = true;
        break;
      }
    }

    if (!found) {
      msg.innerText = "Invalid Username or Password";
      return;
    }

    showApp();

  } catch (err) {
    alert("Unable to load user access list. Check publishing.");
  }
}

function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("appScreen").style.display = "block";
  buildTabs();
  openTab("dashboardTab");
}

function buildTabs() {

  let tabButtons = document.getElementById("tabButtons");
  tabButtons.innerHTML = "";

  let tabs = [
    { id:"dashboardTab", name:"Dashboard" },
    { id:"sheetTab", name:"Master Sheet" },
    { id:"formTab", name:"Submit Form" }
  ];

  if (currentRole === "ADMIN") {
    tabs.push({ id:"accessTab", name:"Access" });
  }

  tabs.forEach(t => {
    let btn = document.createElement("button");
    btn.className = "tab-btn";
    btn.innerText = t.name;
    btn.onclick = () => openTab(t.id);
    tabButtons.appendChild(btn);
  });
}

function openTab(id) {
  document.querySelectorAll(".tab-content").forEach(x => x.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function addUser() {

  let username = document.getElementById("newUsername").value.trim();
  let password = document.getElementById("newPassword").value.trim();
  let role = document.getElementById("newRole").value;

  if (!username || !password) {
    alert("Username and Password required");
    return;
  }

  let form = document.createElement("form");
  form.method = "POST";
  form.action = ADD_USER_SCRIPT_URL;
  form.target = "hidden_iframe";

  let input = document.createElement("input");
  input.type = "hidden";
  input.name = "data";
  input.value = JSON.stringify({ username, password, role });

  form.appendChild(input);
  document.body.appendChild(form);

  form.submit();

  alert("User Added Successfully");

  document.getElementById("newUsername").value = "";
  document.getElementById("newPassword").value = "";
}

</script>

</body>
</html>
