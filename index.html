function doGet(e) {
  try {
    var subdivision = e.parameter.subdivision || "ALL";
    var executive = e.parameter.executive || "ALL";

    var ss = SpreadsheetApp.openById("16iKxtDhV8QBw0q6lyao1IgnBWZKsaGO4cFdx2b58dME");
    var sheet = ss.getSheets()[0]; // Change if your data is not in first sheet

    var data = sheet.getDataRange().getValues();

    if (data.length < 2) {
      return ContentService.createTextOutput("No data found.");
    }

    var headers = data[0];
    var rows = data.slice(1);

    // Find column index for Executive and Sub Division
    var execIndex = headers.indexOf("Executive");
    var subIndex = headers.indexOf("Sub Division");

    // If headers are different in your sheet, set manually
    if (execIndex === -1) execIndex = 0;   // Your HTML uses row[0] for Exec
    if (subIndex === -1) subIndex = 3;     // Your HTML uses row[3] for Sub Division

    var filtered = rows.filter(function(r) {
      var execMatch = (executive === "ALL") || (String(r[execIndex]).trim() === executive);
      var subMatch = (subdivision === "ALL") || (String(r[subIndex]).trim() === subdivision);
      return execMatch && subMatch;
    });

    // Create temp spreadsheet
    var tempSS = SpreadsheetApp.create("Filtered_Export");
    var tempSheet = tempSS.getActiveSheet();

    tempSheet.getRange(1, 1, 1, headers.length).setValues([headers]);

    if (filtered.length > 0) {
      tempSheet.getRange(2, 1, filtered.length, headers.length).setValues(filtered);
    }

    // Export temp spreadsheet as XLSX
    var fileId = tempSS.getId();
    var url = "https://docs.google.com/spreadsheets/d/" + fileId + "/export?format=xlsx";

    var token = ScriptApp.getOAuthToken();
    var response = UrlFetchApp.fetch(url, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    var fileName = "Report_" + subdivision.replace(/[^a-zA-Z0-9]/g, "_") + ".xlsx";

    // Delete temp spreadsheet after export
    DriveApp.getFileById(fileId).setTrashed(true);

    return ContentService
      .createTextOutput(response.getContent())
      .setMimeType(ContentService.MimeType.MICROSOFT_EXCEL)
      .setHeader("Content-Disposition", "attachment; filename=" + fileName);

  } catch (err) {
    return ContentService.createTextOutput("ERROR: " + err.message);
  }
}
